--- net/minecraft/world/level/NaturalSpawner.java
+++ net/minecraft/world/level/NaturalSpawner.java
@@ -4,17 +4,19 @@
 import it.unimi.dsi.fastutil.objects.Object2IntMaps;
 import it.unimi.dsi.fastutil.objects.Object2IntOpenHashMap;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Objects;
+import java.util.Optional;
 import java.util.Random;
 import java.util.function.Consumer;
 import java.util.stream.Stream;
 import javax.annotation.Nullable;
 import net.minecraft.core.BlockPos;
 import net.minecraft.core.Direction;
 import net.minecraft.core.Registry;
+import net.minecraft.core.SectionPos;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.server.level.ServerLevel;
 import net.minecraft.tags.BlockTags;
 import net.minecraft.tags.FluidTags;
 import net.minecraft.util.Mth;
@@ -74,11 +76,11 @@
          } while(var7.isPersistenceRequired() || var7.requiresCustomPersistence());
 
          MobCategory var11 = var6.getType().getCategory();
          if (var11 != MobCategory.MISC) {
             BlockPos var8 = var6.blockPosition();
-            long var9 = ChunkPos.asLong(var8.getX() >> 4, var8.getZ() >> 4);
+            long var9 = ChunkPos.asLong(SectionPos.blockToSectionCoord(var8.getX()), SectionPos.blockToSectionCoord(var8.getZ()));
             var2.query(var9, (var5x) -> {
                MobSpawnSettings.MobSpawnCost var6x = getRoughBiome(var8, var5x).getMobSettings().getMobSpawnCost(var6.getType());
                if (var6x != null) {
                   var3.addCharge(var6.blockPosition(), var6x.getCharge());
                }
@@ -112,11 +114,11 @@
       var0.getProfiler().pop();
    }
 
    public static void spawnCategoryForChunk(MobCategory var0, ServerLevel var1, LevelChunk var2, NaturalSpawner.SpawnPredicate var3, NaturalSpawner.AfterSpawnCallback var4) {
       BlockPos var5 = getRandomPosWithin(var1, var2);
-      if (var5.getY() >= 1) {
+      if (var5.getY() >= var1.getMinBuildHeight() + 1) {
          spawnCategoryForPosition(var0, var1, var2, var5, var3, var4);
       }
    }
 
    public static void spawnCategoryForPosition(MobCategory var0, ServerLevel var1, ChunkAccess var2, BlockPos var3, NaturalSpawner.SpawnPredicate var4, NaturalSpawner.AfterSpawnCallback var5) {
@@ -146,36 +148,37 @@
                Player var25 = var1.getNearestPlayer(var21, (double)var8, var23, -1.0D, false);
                if (var25 != null) {
                   double var26 = var25.distanceToSqr(var21, (double)var8, var23);
                   if (isRightDistanceToPlayerAndSpawnPoint(var1, var2, var10, var26)) {
                      if (var16 == null) {
-                        var16 = getRandomSpawnMobAt(var1, var6, var7, var0, var1.random, var10);
-                        if (var16 == null) {
+                        Optional var28 = getRandomSpawnMobAt(var1, var6, var7, var0, var1.random, var10);
+                        if (!var28.isPresent()) {
                            break;
                         }
 
+                        var16 = (MobSpawnSettings.SpawnerData)var28.get();
                         var18 = var16.minCount + var1.random.nextInt(1 + var16.maxCount - var16.minCount);
                      }
 
                      if (isValidSpawnPostitionForType(var1, var0, var6, var7, var16, var10, var26) && var4.test(var16.type, var10, var2)) {
-                        Mob var28 = getMobForSpawn(var1, var16.type);
-                        if (var28 == null) {
+                        Mob var29 = getMobForSpawn(var1, var16.type);
+                        if (var29 == null) {
                            return;
                         }
 
-                        var28.moveTo(var21, (double)var8, var23, var1.random.nextFloat() * 360.0F, 0.0F);
-                        if (isValidPositionForMob(var1, var28, var26)) {
-                           var17 = var28.finalizeSpawn(var1, var1.getCurrentDifficultyAt(var28.blockPosition()), MobSpawnType.NATURAL, var17, (CompoundTag)null);
+                        var29.moveTo(var21, (double)var8, var23, var1.random.nextFloat() * 360.0F, 0.0F);
+                        if (isValidPositionForMob(var1, var29, var26)) {
+                           var17 = var29.finalizeSpawn(var1, var1.getCurrentDifficultyAt(var29.blockPosition()), MobSpawnType.NATURAL, var17, (CompoundTag)null);
                            ++var11;
                            ++var19;
-                           var1.addFreshEntityWithPassengers(var28);
-                           var5.run(var28, var2);
-                           if (var11 >= var28.getMaxSpawnClusterSize()) {
+                           var1.addFreshEntityWithPassengers(var29);
+                           var5.run(var29, var2);
+                           if (var11 >= var29.getMaxSpawnClusterSize()) {
                               return;
                            }
 
-                           if (var28.isMaxGroupSizeReached(var19)) {
+                           if (var29.isMaxGroupSizeReached(var19)) {
                               break;
                            }
                         }
                      }
                   }
@@ -239,35 +242,34 @@
       } else {
          return var1.checkSpawnRules(var0, MobSpawnType.NATURAL) && var1.checkSpawnObstruction(var0);
       }
    }
 
-   @Nullable
-   private static MobSpawnSettings.SpawnerData getRandomSpawnMobAt(ServerLevel var0, StructureFeatureManager var1, ChunkGenerator var2, MobCategory var3, Random var4, BlockPos var5) {
+   private static Optional<MobSpawnSettings.SpawnerData> getRandomSpawnMobAt(ServerLevel var0, StructureFeatureManager var1, ChunkGenerator var2, MobCategory var3, Random var4, BlockPos var5) {
       Biome var6 = var0.getBiome(var5);
       if (var3 == MobCategory.WATER_AMBIENT && var6.getBiomeCategory() == Biome.BiomeCategory.RIVER && var4.nextFloat() < 0.98F) {
-         return null;
+         return Optional.empty();
       } else {
          List var7 = mobsAt(var0, var1, var2, var3, var5, var6);
-         return var7.isEmpty() ? null : (MobSpawnSettings.SpawnerData)WeighedRandom.getRandomItem(var4, var7);
+         return var7.isEmpty() ? Optional.empty() : WeighedRandom.getRandomItem(var4, var7);
       }
    }
 
    private static boolean canSpawnMobAt(ServerLevel var0, StructureFeatureManager var1, ChunkGenerator var2, MobCategory var3, MobSpawnSettings.SpawnerData var4, BlockPos var5) {
       return mobsAt(var0, var1, var2, var3, var5, (Biome)null).contains(var4);
    }
 
    private static List<MobSpawnSettings.SpawnerData> mobsAt(ServerLevel var0, StructureFeatureManager var1, ChunkGenerator var2, MobCategory var3, BlockPos var4, @Nullable Biome var5) {
-      return var3 == MobCategory.MONSTER && var0.getBlockState(var4.below()).getBlock() == Blocks.NETHER_BRICKS && var1.getStructureAt(var4, false, StructureFeature.NETHER_BRIDGE).isValid() ? StructureFeature.NETHER_BRIDGE.getSpecialEnemies() : var2.getMobsAt(var5 != null ? var5 : var0.getBiome(var4), var1, var3, var4);
+      return var3 == MobCategory.MONSTER && var0.getBlockState(var4.below()).is(Blocks.NETHER_BRICKS) && var1.getStructureAt(var4, false, StructureFeature.NETHER_BRIDGE).isValid() ? StructureFeature.NETHER_BRIDGE.getSpecialEnemies() : var2.getMobsAt(var5 != null ? var5 : var0.getBiome(var4), var1, var3, var4);
    }
 
    private static BlockPos getRandomPosWithin(Level var0, LevelChunk var1) {
       ChunkPos var2 = var1.getPos();
       int var3 = var2.getMinBlockX() + var0.random.nextInt(16);
       int var4 = var2.getMinBlockZ() + var0.random.nextInt(16);
       int var5 = var1.getHeight(Heightmap.Types.WORLD_SURFACE, var3, var4) + 1;
-      int var6 = var0.random.nextInt(var5 + 1);
+      int var6 = var0.random.nextInt(var5 - var0.getMinBuildHeight() + 1) + var0.getMinBuildHeight();
       return new BlockPos(var3, var6, var4);
    }
 
    public static boolean isValidEmptySpawnBlock(BlockGetter var0, BlockPos var1, BlockState var2, FluidState var3, EntityType<?> var4) {
       if (var2.isCollisionShapeFullBlock(var0, var1)) {
@@ -312,63 +314,71 @@
 
    public static void spawnMobsForChunkGeneration(ServerLevelAccessor var0, Biome var1, int var2, int var3, Random var4) {
       MobSpawnSettings var5 = var1.getMobSettings();
       List var6 = var5.getMobs(MobCategory.CREATURE);
       if (!var6.isEmpty()) {
-         int var7 = var2 << 4;
-         int var8 = var3 << 4;
+         int var7 = SectionPos.sectionToBlockCoord(var2);
+         int var8 = SectionPos.sectionToBlockCoord(var3);
 
-         while(var4.nextFloat() < var5.getCreatureProbability()) {
-            MobSpawnSettings.SpawnerData var9 = (MobSpawnSettings.SpawnerData)WeighedRandom.getRandomItem(var4, var6);
-            int var10 = var9.minCount + var4.nextInt(1 + var9.maxCount - var9.minCount);
-            SpawnGroupData var11 = null;
-            int var12 = var7 + var4.nextInt(16);
-            int var13 = var8 + var4.nextInt(16);
-            int var14 = var12;
+         while(true) {
+            Optional var9;
+            do {
+               if (var4.nextFloat() >= var5.getCreatureProbability()) {
+                  return;
+               }
+
+               var9 = WeighedRandom.getRandomItem(var4, var6);
+            } while(!var9.isPresent());
+
+            MobSpawnSettings.SpawnerData var10 = (MobSpawnSettings.SpawnerData)var9.get();
+            int var11 = var10.minCount + var4.nextInt(1 + var10.maxCount - var10.minCount);
+            SpawnGroupData var12 = null;
+            int var13 = var7 + var4.nextInt(16);
+            int var14 = var8 + var4.nextInt(16);
             int var15 = var13;
+            int var16 = var14;
 
-            for(int var16 = 0; var16 < var10; ++var16) {
-               boolean var17 = false;
+            for(int var17 = 0; var17 < var11; ++var17) {
+               boolean var18 = false;
 
-               for(int var18 = 0; !var17 && var18 < 4; ++var18) {
-                  BlockPos var19 = getTopNonCollidingPos(var0, var9.type, var12, var13);
-                  if (var9.type.canSummon() && isSpawnPositionOk(SpawnPlacements.getPlacementType(var9.type), var0, var19, var9.type)) {
-                     float var20 = var9.type.getWidth();
-                     double var21 = Mth.clamp((double)var12, (double)var7 + (double)var20, (double)var7 + 16.0D - (double)var20);
-                     double var23 = Mth.clamp((double)var13, (double)var8 + (double)var20, (double)var8 + 16.0D - (double)var20);
-                     if (!var0.noCollision(var9.type.getAABB(var21, (double)var19.getY(), var23)) || !SpawnPlacements.checkSpawnRules(var9.type, var0, MobSpawnType.CHUNK_GENERATION, new BlockPos(var21, (double)var19.getY(), var23), var0.getRandom())) {
+               for(int var19 = 0; !var18 && var19 < 4; ++var19) {
+                  BlockPos var20 = getTopNonCollidingPos(var0, var10.type, var13, var14);
+                  if (var10.type.canSummon() && isSpawnPositionOk(SpawnPlacements.getPlacementType(var10.type), var0, var20, var10.type)) {
+                     float var21 = var10.type.getWidth();
+                     double var22 = Mth.clamp((double)var13, (double)var7 + (double)var21, (double)var7 + 16.0D - (double)var21);
+                     double var24 = Mth.clamp((double)var14, (double)var8 + (double)var21, (double)var8 + 16.0D - (double)var21);
+                     if (!var0.noCollision(var10.type.getAABB(var22, (double)var20.getY(), var24)) || !SpawnPlacements.checkSpawnRules(var10.type, var0, MobSpawnType.CHUNK_GENERATION, new BlockPos(var22, (double)var20.getY(), var24), var0.getRandom())) {
                         continue;
                      }
 
-                     Entity var25;
+                     Entity var26;
                      try {
-                        var25 = var9.type.create(var0.getLevel());
-                     } catch (Exception var27) {
-                        LOGGER.warn((String)"Failed to create mob", (Throwable)var27);
+                        var26 = var10.type.create(var0.getLevel());
+                     } catch (Exception var28) {
+                        LOGGER.warn((String)"Failed to create mob", (Throwable)var28);
                         continue;
                      }
 
-                     var25.moveTo(var21, (double)var19.getY(), var23, var4.nextFloat() * 360.0F, 0.0F);
-                     if (var25 instanceof Mob) {
-                        Mob var26 = (Mob)var25;
-                        if (var26.checkSpawnRules(var0, MobSpawnType.CHUNK_GENERATION) && var26.checkSpawnObstruction(var0)) {
-                           var11 = var26.finalizeSpawn(var0, var0.getCurrentDifficultyAt(var26.blockPosition()), MobSpawnType.CHUNK_GENERATION, var11, (CompoundTag)null);
-                           var0.addFreshEntityWithPassengers(var26);
-                           var17 = true;
+                     var26.moveTo(var22, (double)var20.getY(), var24, var4.nextFloat() * 360.0F, 0.0F);
+                     if (var26 instanceof Mob) {
+                        Mob var27 = (Mob)var26;
+                        if (var27.checkSpawnRules(var0, MobSpawnType.CHUNK_GENERATION) && var27.checkSpawnObstruction(var0)) {
+                           var12 = var27.finalizeSpawn(var0, var0.getCurrentDifficultyAt(var27.blockPosition()), MobSpawnType.CHUNK_GENERATION, var12, (CompoundTag)null);
+                           var0.addFreshEntityWithPassengers(var27);
+                           var18 = true;
                         }
                      }
                   }
 
-                  var12 += var4.nextInt(5) - var4.nextInt(5);
+                  var13 += var4.nextInt(5) - var4.nextInt(5);
 
-                  for(var13 += var4.nextInt(5) - var4.nextInt(5); var12 < var7 || var12 >= var7 + 16 || var13 < var8 || var13 >= var8 + 16; var13 = var15 + var4.nextInt(5) - var4.nextInt(5)) {
-                     var12 = var14 + var4.nextInt(5) - var4.nextInt(5);
+                  for(var14 += var4.nextInt(5) - var4.nextInt(5); var13 < var7 || var13 >= var7 + 16 || var14 < var8 || var14 >= var8 + 16; var14 = var16 + var4.nextInt(5) - var4.nextInt(5)) {
+                     var13 = var15 + var4.nextInt(5) - var4.nextInt(5);
                   }
                }
             }
          }
-
       }
    }
 
    private static BlockPos getTopNonCollidingPos(LevelReader var0, EntityType<?> var1, int var2, int var3) {
       int var4 = var0.getHeight(SpawnPlacements.getHeightmapType(var1), var2, var3);
@@ -378,11 +388,11 @@
             var5.move(Direction.DOWN);
          } while(!var0.getBlockState(var5).isAir());
 
          do {
             var5.move(Direction.DOWN);
-         } while(var0.getBlockState(var5).isAir() && var5.getY() > 0);
+         } while(var0.getBlockState(var5).isAir() && var5.getY() > var0.getMinBuildHeight());
       }
 
       if (SpawnPlacements.getPlacementType(var1) == SpawnPlacements.Type.ON_GROUND) {
          BlockPos var6 = var5.below();
          if (var0.getBlockState(var6).isPathfindable(var0, var6, PathComputationType.LAND)) {
